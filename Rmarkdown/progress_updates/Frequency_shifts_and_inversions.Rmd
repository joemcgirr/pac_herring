---
title: "Frequency shifts and inversions"
author: "Joe McGirr"
date: '`r Sys.Date()`'
output:
  html_document:
    code_folding: hide
    collapsed: no
    df_print: paged
    number_sections: no
    theme: paper
    toc: yes
    toc_depth: 5
    toc_float: yes
  html_notebook:
    toc: yes
    toc_depth: 5
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(tidyverse)
library(reticulate)
library(reshape2)
library(plyranges)
library(seqinr)
library(windowscanr)
library(ggpubr)
#BiocManager::install("seqinr")


# color-blind friendly 
# Wong, B. Points of view: Color blindness. Nat Methods (2011).
bla <- "#000000"
blu <- "#0072b2"
grb <- "#56b4e9"
lir <- "#cc79a7"
gre <- "#009e73"
red <- "#d55e00"
org <- "#e69f00"
yel <- "#f0e442"
gry<-  '#BBBBBB'

```

# Compare magnitude of AF shifts between populations

Updated view with 1MB windows. The swings between sampling years from genome-wide positive ∆z to negative ∆z are more exaggerated when averaging across large windows.

  
```{r, message=FALSE, warning=FALSE, fig.width= 10, fig.height= 7}

win <- "1mb"
step <- "100kb"

freqs_win_p <- read.table(paste("C:/Users/jmcgirr/Documents/Whitehead_Lab/ph/freqs/window/PWS_shifts_",win,"_win_",step,"_step.txt",sep = ""))
freqs_win_t <- read.table(paste("C:/Users/jmcgirr/Documents/Whitehead_Lab/ph/freqs/window/TB_shifts_",win,"_win_",step,"_step.txt",sep = ""))
freqs_win_s <- read.table(paste("C:/Users/jmcgirr/Documents/Whitehead_Lab/ph/freqs/window/SS_shifts_",win,"_win_",step,"_step.txt",sep = ""))

all_pops <- data.frame(chr = freqs_win_p$chr,
                       win_mid = freqs_win_p$win_mid,
                       zt01_p = freqs_win_p$zt01_mean,
                       zt02_p = freqs_win_p$zt02_mean,
                       zt03_p = freqs_win_p$zt03_mean,
                       zt12_p = freqs_win_p$zt12_mean,
                       zt13_p = freqs_win_p$zt13_mean,
                       zt23_p = freqs_win_p$zt23_mean,
                       zt01_t = freqs_win_t$zt01_mean,
                       zt02_t = freqs_win_t$zt02_mean,
                       zt03_t = freqs_win_t$zt03_mean,
                       zt12_t = freqs_win_t$zt12_mean,
                       zt13_t = freqs_win_t$zt13_mean,
                       zt23_t = freqs_win_t$zt23_mean,
                       zt12_s = freqs_win_s$zt12_mean,
                       zt13_s = freqs_win_s$zt13_mean,
                       zt23_s = freqs_win_s$zt23_mean)


all_pops$chr_num <- factor(all_pops$chr, levels = c(1:26))

zp <- data.frame(z91_96 = all_pops$zt01_p,pop = "PWS")
zt <- data.frame(z91_96 = all_pops$zt01_t,pop = "TB")
z <- rbind(zp,zt)

p<-ggplot(z, aes(x=z91_96, fill=pop)) +
   geom_density(alpha=0.4)+
   scale_fill_manual(name = "Population",values=c(red,blu))+
   ylab("density\n") + xlab(expression(paste(Delta, "z 1991-1996")))+
   theme_minimal()
p


zp <- data.frame(z96_07 = all_pops$zt12_p,pop = "PWS")
zt <- data.frame(z96_07 = all_pops$zt12_t,pop = "TB")
zs <- data.frame(z96_07 = all_pops$zt12_s,pop = "SS")

z <- rbind(zp,zt,zs)

p<-ggplot(z, aes(x=z96_07, fill=pop)) +
   geom_density(alpha=0.4)+
   scale_fill_manual(name = "Population",values=c(red,yel,blu))+
   ylab("density\n") + xlab(expression(paste(Delta, "z 2007-2017")))+
   theme_minimal()
p

zp <- data.frame(z07_17 = all_pops$zt23_p,pop = "PWS")
zt <- data.frame(z07_17 = all_pops$zt23_t,pop = "TB")
zs <- data.frame(z07_17 = all_pops$zt23_s,pop = "SS")

z <- rbind(zp,zt,zs)

p<-ggplot(z, aes(x=z07_17, fill=pop)) +
   geom_density(alpha=0.4)+
   scale_fill_manual(name = "Population",values=c(red,yel,blu))+
   ylab("density\n") + xlab(expression(paste(Delta, "z 2007-2017")))+
   theme_minimal()
p


```

# Here is a chromosome level view of ∆z 1991-1996 for Prince William Sound

```{r, message=FALSE, warning=FALSE, fig.width= 10, fig.height= 7}

plot_af_chromosomes <- function(pop,years,win,step){

freqs_win <- read.table(paste("C:/Users/jmcgirr/Documents/Whitehead_Lab/ph/freqs/window/",pop,"_shifts_",win,"_win_",step,"_step.txt", sep = ""))
freqs_win$chr_num <- factor(freqs_win$chr, levels = c(1:26))

p <- ggplot(freqs_win, aes_string(x = "win_mid", y = years)) + 
     geom_point(size = 1, color = gry,alpha = 0.7, shape = 1)+
     theme_minimal()+
     theme(axis.text.x=element_blank())+
     ylab(expression(paste(Delta, "z")))+ xlab("")+ 
     geom_smooth(method = "loess", se = FALSE, span = 1/10, color = red)+
     facet_wrap(~chr_num, ncol = 9)+
     ggtitle(paste(pop,years, sep = " "))
print(p)
}


plot_af_chromosomes_within <- function(pop,win,step){

freqs_win <- read.table(paste("C:/Users/jmcgirr/Documents/Whitehead_Lab/ph/freqs/window/",pop,"_shifts_",win,"_win_",step,"_step.txt", sep = ""))
freqs_win$chr_num <- factor(freqs_win$chr, levels = c(1:26))
p <- ggplot(freqs_win, aes_string(x = "win_mid", y = "zt01_mean")) + 
  theme_minimal()+
  theme(axis.text.x=element_blank())+
  ylab(expression(paste(Delta, "z")))+ xlab("")+ 
  geom_smooth(aes_string(x = "win_mid", y = "zt01_mean", color = "grb"),method = "loess", se = FALSE, span = 1/10)+
  geom_smooth(aes_string(x = "win_mid", y = "zt12_mean", color = "lir"),method = "loess", se = FALSE, span = 1/10)+
  geom_smooth(aes_string(x = "win_mid", y = "zt23_mean", color = "org"),method = "loess", se = FALSE, span = 1/10)+
  facet_wrap(~chr_num, ncol = 9)+
  scale_color_manual(values=c(lir,grb,org),name = "contrast",
                     labels = c("1991-1996", "1996-2007", "2007-2017"))+
  ylim(-0.05, 0.05)+theme(legend.position = c(0.95, 0.2))+
  ggtitle(pop)
print(p)

}


# Within Population

pop <- "PWS"
plot_af_chromosomes(pop,"zt01_mean",win,step)

```

# What is that huge peak on chromosome 7?

# Here is Fst between PWS and the San Francisco Bay population (both sampled 2017).

```{r, message=FALSE, warning=FALSE, fig.width= 10, fig.height= 7}

pop_names = c("PWS91","PWS96","PWS07","PWS17","TB91","TB96","TB06","TB17","SS96","SS06","SS17","BC17","WA17","CA17")

fsts <- list.files(path="C:/Users/jmcgirr/Documents/Whitehead_Lab/ph/fst_pbs/maf05/", full.names=T)
f <- fsts[11]


pops <- strsplit(f, "_")
pops <- c(pops[[1]][10], pops[[1]][11],gsub("\\.txt","",pops[[1]][12]))

fst <-read.delim(paste("C:/Users/jmcgirr/Documents/Whitehead_Lab/ph/fst_pbs/maf05/fst_pbs_50kb_win_10kb_step_folded_",pops[1],"_",pops[2],"_",pops[3],".txt", sep = ""))
#head(fst)
fst <- fst %>% mutate(chr = as.numeric(gsub("chr", "", chr)))
fst$chr_num <- factor(fst$chr, levels = c(1:26))

# Fst
p <- ggplot(fst, aes(x = midPos, y = Fst12)) + 
     geom_point(size = 1, color = gry,alpha = 0.4, shape = 1)+
     theme_minimal()+
     theme(axis.text.x=element_blank())+
     ylab("Fst\n")+ xlab("")+ 
     ggtitle(paste(pops[2],"vs. ", pops[3]))+
     geom_smooth(method = "loess", se = FALSE, span = 1/10, color = blu)+
     facet_wrap(~chr_num, ncol = 9)
print(p)

```

### We think these peaks on 7,12,15,16,20 are large inversions. It is really interesting that big peaks in ∆z line up with these inversions.

### We dont see the same strong signals of inversions when we measure Fst between PWS, SS and TB, but there are definitely interesting things happening in those regions

# Here is Fst between PWS, SS, and TB

```{r, message=FALSE, warning=FALSE, fig.width= 10, fig.height= 7}

pop_names = c("PWS91","PWS96","PWS07","PWS17","TB91","TB96","TB06","TB17","SS96","SS06","SS17","BC17","WA17","CA17")

fsts <- list.files(path="C:/Users/jmcgirr/Documents/Whitehead_Lab/ph/fst_pbs/maf05/", full.names=T)
f <- fsts[12]


pops <- strsplit(f, "_")
pops <- c(pops[[1]][10], pops[[1]][11],gsub("\\.txt","",pops[[1]][12]))

fst <-read.delim(paste("C:/Users/jmcgirr/Documents/Whitehead_Lab/ph/fst_pbs/maf05/fst_pbs_50kb_win_10kb_step_folded_",pops[1],"_",pops[2],"_",pops[3],".txt", sep = ""))
#head(fst)
fst <- fst %>% mutate(chr = as.numeric(gsub("chr", "", chr)))
fst$chr_num <- factor(fst$chr, levels = c(1:26))

# Fst
p <- ggplot(fst, aes(x = midPos, y = Fst01)) + 
     geom_point(size = 1, color = gry,alpha = 0.4, shape = 1)+
     theme_minimal()+
     theme(axis.text.x=element_blank())+
     ylab("Fst\n")+ xlab("")+ 
     ggtitle(paste(pops[1],"vs. ", pops[2]))+
     geom_smooth(method = "loess", se = FALSE, span = 1/10, color = blu)+
     facet_wrap(~chr_num, ncol = 9)
print(p)

p <- ggplot(fst, aes(x = midPos, y = Fst02)) + 
     geom_point(size = 1, color = gry,alpha = 0.4, shape = 1)+
     theme_minimal()+
     theme(axis.text.x=element_blank())+
     ylab("Fst\n")+ xlab("")+ 
     ggtitle(paste(pops[1],"vs. ", pops[3]))+
     geom_smooth(method = "loess", se = FALSE, span = 1/10, color = blu)+
     facet_wrap(~chr_num, ncol = 9)
print(p)

p <- ggplot(fst, aes(x = midPos, y = Fst12)) + 
     geom_point(size = 1, color = gry,alpha = 0.4, shape = 1)+
     theme_minimal()+
     theme(axis.text.x=element_blank())+
     ylab("Fst\n")+ xlab("")+ 
     ggtitle(paste(pops[2],"vs. ", pops[3]))+
     geom_smooth(method = "loess", se = FALSE, span = 1/10, color = blu)+
     facet_wrap(~chr_num, ncol = 9)
print(p)

```

# Here are more plots showing ∆z within populations

The shifts are practically symmetrical around zero between particular contrasts

```{r, message=FALSE, warning=FALSE, fig.width= 10, fig.height= 7}

pop <- "PWS"
#plot_af_chromosomes(pop,"zt01_mean",win,step)
#plot_af_chromosomes(pop,"zt12_mean",win,step)
#plot_af_chromosomes(pop,"zt23_mean",win,step)
plot_af_chromosomes_within(pop,win,step)

pop <- "TB"
#plot_af_chromosomes(pop,"zt01_mean",win,step)
#plot_af_chromosomes(pop,"zt12_mean",win,step)
#plot_af_chromosomes(pop,"zt23_mean",win,step)
plot_af_chromosomes_within(pop,win,step)

pop <- "SS"
#plot_af_chromosomes(pop,"zt12_mean",win,step)
#plot_af_chromosomes(pop,"zt23_mean",win,step)

freqs_win <- read.table(paste("C:/Users/jmcgirr/Documents/Whitehead_Lab/ph/freqs/window/",pop,"_shifts_",win,"_win_",step,"_step.txt", sep = ""))
freqs_win$chr_num <- factor(freqs_win$chr, levels = c(1:26))

p <- ggplot(freqs_win, aes_string(x = "win_mid", y = "zt12_mean")) + 
  theme_minimal()+
  theme(axis.text.x=element_blank())+
  ylab(expression(paste(Delta, "z")))+ xlab("")+ 
  geom_smooth(aes_string(x = "win_mid", y = "zt12_mean", color = "grb"),method = "loess", se = FALSE, span = 1/10)+
  geom_smooth(aes_string(x = "win_mid", y = "zt23_mean", color = "org"),method = "loess", se = FALSE, span = 1/10)+
  facet_wrap(~chr_num, ncol = 9)+
  scale_color_manual(values=c(grb,org),name = "contrast",
                     labels = c("1996-2007", "2007-2017"))+
  ylim(-0.05, 0.05)+theme(legend.position = c(0.95, 0.2))+
  ggtitle(pop)
print(p)
```

# Here are more plots showing ∆z between populations

```{r, message=FALSE, warning=FALSE, fig.width= 10, fig.height= 7}

# all chrs
chrs <- c(1:26)

all_pops1 <- all_pops[all_pops$chr_num %in% chrs,]
p <- ggplot(all_pops1, aes_string(x = "win_mid", y = "zt01_p")) + 
     theme_minimal()+
     theme(axis.text.x=element_blank())+
     facet_wrap(~chr_num, ncol = 9)+
     ylab(expression(paste(Delta, "z")))+ xlab("")+ 
     geom_smooth(aes_string(x = "win_mid", y = "zt01_p", color = "blu"),
                 method = "loess", se = FALSE, span = 1/10)+
     geom_smooth(aes_string(x = "win_mid", y = "zt01_t", color = "red"),
                 method = "loess", se = FALSE, span = 1/10)+
  scale_color_manual(values=c(red,blu),name = "population",
                     labels = c("PWS","TB"))+
  ylim(-0.05, 0.05)+
  ggtitle("1991-1996")

print(p)
  
p <- ggplot(all_pops1, aes_string(x = "win_mid", y = "zt01_p")) + 
     theme_minimal()+
     theme(axis.text.x=element_blank())+
     facet_wrap(~chr_num, ncol = 9)+
     ylab(expression(paste(Delta, "z")))+ xlab("")+ 
     geom_smooth(aes_string(x = "win_mid", y = "zt12_p", color = "blu"),
                 method = "loess", se = FALSE, span = 1/10)+
     geom_smooth(aes_string(x = "win_mid", y = "zt12_t", color = "red"),
                 method = "loess", se = FALSE, span = 1/10)+
       geom_smooth(aes_string(x = "win_mid", y = "zt12_s", color = "yel"),
                 method = "loess", se = FALSE, span = 1/10)+
  scale_color_manual(values=c(red,blu,yel),name = "population",
                     labels = c("PWS","TB","SS"))+
  ylim(-0.05, 0.05)+
  ggtitle("1996-2006/07")

print(p)

p <- ggplot(all_pops1, aes_string(x = "win_mid", y = "zt01_p")) + 
     theme_minimal()+
     theme(axis.text.x=element_blank())+
     facet_wrap(~chr_num, ncol = 9)+
     ylab(expression(paste(Delta, "z")))+ xlab("")+ 
     geom_smooth(aes_string(x = "win_mid", y = "zt23_p", color = "blu"),
                 method = "loess", se = FALSE, span = 1/10)+
     geom_smooth(aes_string(x = "win_mid", y = "zt23_t", color = "red"),
                 method = "loess", se = FALSE, span = 1/10)+
     geom_smooth(aes_string(x = "win_mid", y = "zt23_s", color = "yel"),
                 method = "loess", se = FALSE, span = 1/10)+
     scale_color_manual(values=c(red,blu,yel),name = "population",
                        labels = c("PWS","TB","SS"))+
  ylim(-0.05, 0.05)+
  ggtitle("2006/07-2017")

print(p)

```

# Zoom in on chromosome 7

PWS and TB show divergent patterns at the putative inversion between 1991-1996 but similar patterns in the following years.

```{r, message=FALSE, warning=FALSE, fig.width= 10, fig.height= 7}

# chr7
chrs <- c(7)

all_pops1 <- all_pops[all_pops$chr_num %in% chrs,]
p <- ggplot(all_pops1, aes_string(x = "win_mid", y = "zt01_p")) + 
     theme_minimal()+
     theme(axis.text.x=element_blank())+
     facet_wrap(~chr_num, ncol = 9)+
     ylab(expression(paste(Delta, "z")))+ xlab("")+ 
     geom_smooth(aes_string(x = "win_mid", y = "zt01_p", color = "blu"),
                 method = "loess", se = FALSE, span = 1/10)+
     geom_smooth(aes_string(x = "win_mid", y = "zt01_t", color = "red"),
                 method = "loess", se = FALSE, span = 1/10)+
  scale_color_manual(values=c(red,blu),name = "population",
                     labels = c("PWS","TB"))+
  ylim(-0.05, 0.05)+
  ggtitle("1991-1996")

print(p)
  
p <- ggplot(all_pops1, aes_string(x = "win_mid", y = "zt01_p")) + 
     theme_minimal()+
     theme(axis.text.x=element_blank())+
     facet_wrap(~chr_num, ncol = 9)+
     ylab(expression(paste(Delta, "z")))+ xlab("")+ 
     geom_smooth(aes_string(x = "win_mid", y = "zt12_p", color = "blu"),
                 method = "loess", se = FALSE, span = 1/10)+
     geom_smooth(aes_string(x = "win_mid", y = "zt12_t", color = "red"),
                 method = "loess", se = FALSE, span = 1/10)+
       geom_smooth(aes_string(x = "win_mid", y = "zt12_s", color = "yel"),
                 method = "loess", se = FALSE, span = 1/10)+
  scale_color_manual(values=c(red,blu,yel),name = "population",
                     labels = c("PWS","TB","SS"))+
  ylim(-0.05, 0.05)+
  ggtitle("1996-2006/07")

print(p)

p <- ggplot(all_pops1, aes_string(x = "win_mid", y = "zt01_p")) + 
     theme_minimal()+
     theme(axis.text.x=element_blank())+
     facet_wrap(~chr_num, ncol = 9)+
     ylab(expression(paste(Delta, "z")))+ xlab("")+ 
     geom_smooth(aes_string(x = "win_mid", y = "zt23_p", color = "blu"),
                 method = "loess", se = FALSE, span = 1/10)+
     geom_smooth(aes_string(x = "win_mid", y = "zt23_t", color = "red"),
                 method = "loess", se = FALSE, span = 1/10)+
     geom_smooth(aes_string(x = "win_mid", y = "zt23_s", color = "yel"),
                 method = "loess", se = FALSE, span = 1/10)+
     scale_color_manual(values=c(red,blu,yel),name = "population",
                        labels = c("PWS","TB","SS"))+
  ylim(-0.05, 0.05)+
  ggtitle("2006/07-2017")

print(p)

```
